function tempSymbols(e){var t={"t͡ʂ":"T","d͡ʐ":"D","j̃":"J","w̃":"W","t̪":"T","d̪":"D","ʦ̪":"C","ʣ̪":"Q",pf:"P"};return e=e.replace(/t͡ʂ|d͡ʐ|j̃|w̃|t̪|d̪|ʦ̪|ʣ̪|pf/gi,function(e){return t[e]})}function identifyCluster(e){function t(e){return segments.segments[e].isVowel?!0:!1}var s=0,n=0,a=0;e=tempSymbols(e);for(var d=0,r=e.length;r>d;d++){if(!segments.segments[e[d]])return"contains illegal characters";if(t(e[d]))if(0===d)n+=1;else{if(!(d=e.length))return"not a cluster";a+=1}else s+=1}return 0===e.length?"no cluster specified":1===n&&1===a?2>s?"not a cluster":2===s?"VCCV":3===s?"VCCCV":"cluster too big":1===n&&0===a?2>s?"not a cluster":2===s?"VCC":3===s?"VCCC":"cluster too big":0===n&&1===a?2>s?"not a cluster":2===s?"CCV":3===s?"CCCV":"cluster too big":"position of vowel(s) not specified"}function calculateNAD(cluster){function calcnadCC(C1,C2){return $("#include-sonority").is(":checked")&&C1.son!==C2.son?eval(Math.abs(C1.moa-C2.moa)+Math.abs(C1.poa-C2.poa)+1):eval(Math.abs(C1.moa-C2.moa)+Math.abs(C1.poa-C2.poa))}function calcnadCV(C,V){return $("#include-sonority").is(":checked")&&C.son!==V.son?eval(Math.abs(C.moa-V.moa)+1):Math.abs(C.moa-V.moa)}cluster=tempSymbols(cluster);var clusterType=identifyCluster(cluster),result="",nadC1C2=0,nadC2C3=0,nadCV=0,nadVC=0,preference="-";switch(clusterType){case"CCV":return nadC1C2=calcnadCC(segments.segments[cluster[0]],segments.segments[cluster[1]]),nadCV=calcnadCV(segments.segments[cluster[1]],segments.segments[cluster[2]]),preference=nadC1C2>=nadCV?"Yes":"No",result="<td>-</td><td>"+nadC1C2.toFixed(1)+"</td><td>-</td><td>"+nadCV.toFixed(1)+"</td><td class='nad'>"+preference+"</td>";case"VCC":return nadC1C2=calcnadCC(segments.segments[cluster[1]],segments.segments[cluster[2]]),nadVC=calcnadCV(segments.segments[cluster[0]],segments.segments[cluster[1]]),preference=nadC1C2>=nadVC?"Yes":"No","<td>"+nadVC.toFixed(1)+"</td><td>"+nadC1C2.toFixed(1)+"</td><td>-</td><td>-</td><td class='nad'>"+preference+"</td>";case"VCCV":return nadVC=calcnadCV(segments.segments[cluster[0]],segments.segments[cluster[1]]),nadCV=calcnadCV(segments.segments[cluster[2]],segments.segments[cluster[3]]),nadC1C2=calcnadCC(segments.segments[cluster[1]],segments.segments[cluster[2]]),preference=nadVC>=nadC1C2&&nadCV>nadC1C2&&nadC1C2>0?"Yes":"No","<td>"+nadVC.toFixed(1)+"</td><td>"+nadC1C2.toFixed(1)+"</td><td>-</td><td>"+nadCV.toFixed(1)+"</td><td class='nad'>"+preference+"</td>";case"CCCV":return nadC1C2=calcnadCC(segments.segments[cluster[0]],segments.segments[cluster[1]]),nadC2C3=calcnadCC(segments.segments[cluster[1]],segments.segments[cluster[2]]),nadCV=calcnadCV(segments.segments[cluster[2]],segments.segments[cluster[3]]),preference=nadC2C3>nadC1C2&&nadC2C3>=nadCV?"Yes":"No",result="<td>-</td><td>"+nadC1C2.toFixed(1)+"</td><td>"+nadC2C3.toFixed(1)+"</td><td>"+nadCV.toFixed(1)+"</td><td class='nad'>"+preference+"</td>";case"VCCC":return nadC1C2=calcnadCC(segments.segments[cluster[1]],segments.segments[cluster[2]]),nadC2C3=calcnadCC(segments.segments[cluster[2]],segments.segments[cluster[3]]),nadVC=calcnadCV(segments.segments[cluster[0]],segments.segments[cluster[1]]),preference=nadC1C2>=nadVC&&nadC1C2>nadC2C3?"Yes":"No",result="<td>"+nadVC.toFixed(1)+"</td><td>"+nadC1C2.toFixed(1)+"</td><td>"+nadC2C3.toFixed(1)+"</td><td>-</td><td class='nad'>"+preference+"</td>";case"VCCCV":return nadC1C2=calcnadCC(segments.segments[cluster[1]],segments.segments[cluster[2]]),nadC2C3=calcnadCC(segments.segments[cluster[2]],segments.segments[cluster[3]]),nadVC=calcnadCV(segments.segments[cluster[0]],segments.segments[cluster[1]]),nadCV=calcnadCV(segments.segments[cluster[3]],segments.segments[cluster[4]]),preference=nadVC>=nadC1C2&&nadCV>nadC2C3?"Yes":"No",result="<td>"+nadVC.toFixed(1)+"</td><td>"+nadC1C2.toFixed(1)+"</td><td>"+nadC2C3.toFixed(1)+"</td><td>"+nadCV.toFixed(1)+"</td><td class='nad'>"+preference+"</td>";default:return"-"}}function modifyNAD(){var e=$(this).attr("id"),t=$(this).val();if("moa"==$(this).attr("class")){var s=$(this).parent().parent().children().index($(this).parent());$(this).parent().parent().parent().children("tr").each(function(){$(this).find("button:not(.empty)").each(function(e,n){if($(this).parent().parent().children().index($(this).parent())===s){var a=$(this).html(),a=tempSymbols(a);segments.segments[a].moa=t}})})}else if("poa"==$(this).attr("class")){var s=$(this).parent().parent().parent().children().index($(this).parent().parent());$(this).parent().parent().parent().children("tr").each(function(){$(this).find("button:not(.empty,.labiovelar)").each(function(n,a){if($(this).parent().parent().parent().children().index($(this).parent().parent())===s){var d=$(this).html(),d=tempSymbols(d);if("bilabialNAD"===e||"velarNAD"===e){segments.segments[d].poa=t;var r=parseFloat($("#bilabialNAD").val(),10)+parseFloat($("#velarNAD").val(),10);segments.segments.w.poa=r/2,"pl"===$("#db").val()?segments.segments.W.poa=r/2:"custom"===$("#db").val()&&(segments.segments["ʍ"].poa=r/2)}else segments.segments[d].poa=t}})})}}var data={};$(document).ready(function(){$("#keyboard-placeholder").load("db/eng.html"),segments=function(){return segments=null,$.ajax({async:!1,global:!1,url:"db/eng.json",dataType:"json",success:function(e){segments=e}}),segments}()}),$("#db").change(function(){var e=$("#db").val();$("#keyboard-placeholder").load("db/"+e+".html"),segments=function(){return segments=null,$.ajax({async:!1,global:!1,url:"db/"+e+".json",dataType:"json",success:function(e){segments=e}}),console.log(segments),segments}()}),$("#target").click(function(){$("#result table tbody").html("");var e=$("#clusters").val().split("\n");$.each(e,function(){$("#result table tbody").append("<tr><td>"+this+"</td><td>"+identifyCluster(this)+"</td>"+calculateNAD(this)+"<tr>")}),$("#result table .nad").each(function(){var e=$(this),t=e.text();if("Yes"===t)e.parent().addClass("success");else{if("No"!==t)return!1;e.parent().addClass("error")}})}),$("#remove").click(function(){$("#clusters").val("")}),$("#clear-table").click(function(){$("#result table tbody").html("")}),$("body").on("keypress","input[type=number]",function(e){46==e.which&&-1==$(this).val().indexOf(".")||!(e.which<48||e.which>57)?46==e.which&&0==$(this).val().length?e.preventDefault():-1!=$(this).val().indexOf(".")&&$(this).val().substring($(this).val().indexOf("."),$(this).val().indexOf(".").length).length>1&&e.preventDefault():e.preventDefault()}),$("body").on("change","input[type=number]",function(){$.proxy(modifyNAD,$(this))()});var customNADloaded=0;$("#clusters").change(function(){"custom"===$("#db").val()&&0===customNADloaded&&($("input[type=number]").each(function(){$.proxy(modifyNAD,$(this))()}),customNADloaded=1)});